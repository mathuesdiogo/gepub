{% extends "core/base.html" %}
{% block title %}Unidades • Organização • GEPUB{% endblock %}
{% block header %}Organização{% endblock %}

{% block breadcrumbs %}
  <div class="breadcrumbs">
    <a class="breadcrumbs__link" href="{% url 'core:dashboard' %}">Início</a>
    <span class="breadcrumbs__sep">/</span>
    <a class="breadcrumbs__link" href="{% url 'org:index' %}">Organização</a>
    <span class="breadcrumbs__sep">/</span>
    <span class="breadcrumbs__current">Unidades</span>
  </div>
{% endblock %}


{% block content %}
  <div class="card">
    <div class="card__title" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <span>Unidades</span>
      <a class="link" href="{% url 'org:unidade_create' %}">+ Nova unidade</a>
    </div>

    <div class="card__body">
      <form method="get" style="display:flex; gap:10px; flex-wrap:wrap; align-items:end; margin-bottom:12px;">
        <div style="min-width:240px; flex:1;">
          <label class="small">Buscar</label><br>
          <input name="q" value="{{ q }}" placeholder="Nome, INEP, CNPJ, secretaria ou município..." />
        </div>

        <div style="min-width:260px;">
          <label class="small">Município</label><br>
          <select name="municipio">
            <option value="">Todos</option>
            {% for m in municipios %}
              <option value="{{ m.id }}" {% if municipio_id|stringformat:"s" == m.id|stringformat:"s" %}selected{% endif %}>
                {{ m.nome }} / {{ m.uf }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div style="min-width:280px;">
          <label class="small">Secretaria</label><br>
          <select name="secretaria">
            <option value="">Todas</option>
            {% for s in secretarias %}
              <option value="{{ s.id }}" {% if secretaria_id|stringformat:"s" == s.id|stringformat:"s" %}selected{% endif %}>
                {{ s.nome }} ({{ s.municipio.uf }})
              </option>
            {% endfor %}
          </select>
        </div>

        <div style="min-width:200px;">
          <label class="small">Tipo</label><br>
          <select name="tipo">
            <option value="">Todos</option>
            {% for value,label in tipos %}
              <option value="{{ value }}" {% if tipo == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <button type="submit">Filtrar</button>

        {% if q or municipio_id or secretaria_id or tipo %}
          <a class="link" href="{% url 'org:unidade_list' %}">Limpar</a>
        {% endif %}
      </form>

      <div style="overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:14px;">
        <table style="width:100%; border-collapse:collapse; min-width:980px;">
          <thead>
            <tr style="text-align:left; background:rgba(255,255,255,.03);">
              <th style="padding:10px 12px;">Nome</th>
              <th style="padding:10px 12px; width:140px;">Tipo</th>
              <th style="padding:10px 12px; width:140px;">INEP</th>
              <th style="padding:10px 12px; width:170px;">CNPJ</th>
              <th style="padding:10px 12px;">Secretaria</th>
              <th style="padding:10px 12px;">Município</th>
              <th style="padding:10px 12px; width:90px;">Ativo</th>
              <th style="padding:10px 12px; width:140px;">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for u in page_obj %}
              <tr style="border-top:1px solid rgba(255,255,255,.06);">
                <td style="padding:10px 12px;">
                  <a class="link" href="{% url 'org:unidade_detail' u.pk %}">{{ u.nome }}</a>
                </td>
                <td style="padding:10px 12px;">{{ u.get_tipo_display }}</td>
                <td style="padding:10px 12px;">{{ u.codigo_inep|default:"—" }}</td>
                <td style="padding:10px 12px;">{{ u.cnpj|default:"—" }}</td>
                <td style="padding:10px 12px;">{{ u.secretaria.nome }}</td>
                <td style="padding:10px 12px;">{{ u.secretaria.municipio.nome }} / {{ u.secretaria.municipio.uf }}</td>
                <td style="padding:10px 12px;">{% if u.ativo %}Sim{% else %}Não{% endif %}</td>
                <td style="padding:10px 12px;">
                  <a class="link" href="{% url 'org:unidade_update' u.pk %}">Editar</a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="8" style="padding:12px;">Nenhuma unidade encontrada.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if page_obj.paginator.num_pages > 1 %}
        <div style="display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap:wrap;">
          <span class="small">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

          <div style="display:flex; gap:8px; align-items:center;">
            {% if page_obj.has_previous %}
              <a class="link" href="?q={{ q|urlencode }}&municipio={{ municipio_id|urlencode }}&secretaria={{ secretaria_id|urlencode }}&tipo={{ tipo|urlencode }}&page={{ page_obj.previous_page_number }}">Anterior</a>
            {% endif %}
            {% if page_obj.has_next %}
              <a class="link" href="?q={{ q|urlencode }}&municipio={{ municipio_id|urlencode }}&secretaria={{ secretaria_id|urlencode }}&tipo={{ tipo|urlencode }}&page={{ page_obj.next_page_number }}">Próxima</a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
