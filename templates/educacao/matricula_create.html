{% extends "educacao/base_modulo.html" %}
{% block title %}Nova Matrícula • Educação • GEPUB{% endblock %}

{% block breadcrumbs %}
  <div class="breadcrumbs">
    <a class="breadcrumbs__link" href="{% url 'core:dashboard' %}">Início</a>
    <span class="breadcrumbs__sep">/</span>
    <a class="breadcrumbs__link" href="{% url 'educacao:index' %}">Educação</a>
    <span class="breadcrumbs__sep">/</span>
    <span class="breadcrumbs__current">Nova Matrícula</span>
  </div>
{% endblock %}

{% block module_content %}
  <div class="card educacao-matricula-create">
    <div class="card__body">

      {% include "core/partials/components/layout/page_head.html" with title="Nova matrícula" subtitle="Busque o aluno e confirme os dados" actions=actions%}

      <div class="u-grid-2">
        <div class="section">
          <div class="section__header">
            <div class="section__title">1. Buscar e selecionar aluno</div>
            <div class="section__meta">Digite nome, CPF ou NIS e selecione pelo autocomplete.</div>
          </div>

          <form method="get" action="{{ search_action_url }}" class="matricula-search-form">
            <div class="matricula-search-form__field">
              <label class="small">Buscar aluno</label>
              <input
                name="q"
                value="{{ q|default:'' }}"
                placeholder="Digite nome, CPF ou NIS..."
                autocomplete="off"
                data-autocomplete-url="{{ autocomplete_url }}"
                data-autocomplete-mode="fill"
                data-autocomplete-fill-target="#id_aluno_pick"
                data-autocomplete-min="2"
              />
              <input type="hidden" id="id_aluno_pick" name="aluno" value="{% if selected_aluno %}{{ selected_aluno.pk }}{% endif %}">
              {% if unidade %}
                <input type="hidden" name="unidade" value="{{ unidade }}">
              {% endif %}
            </div>
            <div class="matricula-search-form__actions">
              <button class="btn btn-primary" type="submit">Selecionar aluno</button>
              <a class="btn btn--ghost" href="{{ clear_url }}">Limpar</a>
            </div>
          </form>

          <div class="small matricula-search-hint">
            Dica: para seleção exata, pesquise por CPF completo.
          </div>
        </div>

        <div class="section">
          <div class="section__header">
            <div class="section__title">2. Confirmar dados da matrícula</div>
            <div class="section__meta">Selecione turma, data e situação.</div>
          </div>

          {% if selected_aluno %}
            <div class="matricula-selected">
              <div class="matricula-selected__title">Aluno selecionado</div>
              <div class="matricula-selected__name">{{ selected_aluno.nome }}</div>
              <div class="matricula-selected__meta">
                <span><strong>CPF:</strong> {{ selected_aluno.cpf|default:"—" }}</span>
                <span><strong>NIS:</strong> {{ selected_aluno.nis|default:"—" }}</span>
              </div>
            </div>

            {% if rows_selected_matriculas %}
              <div class="matricula-selected-history">
                <div class="small matricula-selected-history__title">Matrículas já existentes no escopo</div>
                {% include "core/partials/components/data/table_shell.html" with headers=headers_selected_matriculas rows=rows_selected_matriculas page_obj=None empty_title="Sem matrículas anteriores" empty_text="" %}
              </div>
            {% endif %}
          {% else %}
            <div class="matricula-selected matricula-selected--empty">
              Selecione um aluno na lista ao lado para habilitar o envio da matrícula.
            </div>
          {% endif %}

          {% include "core/partials/components/forms/form_shell.html" with form=form action_url=form_action_url cancel_url=clear_url submit_label="Confirmar matrícula" top_extra=top_extra %}
        </div>
      </div>

    </div>
  </div>
{% endblock %}
