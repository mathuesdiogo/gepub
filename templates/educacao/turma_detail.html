{% extends "core/base.html" %}
{% block title %}{{ turma.nome }} • Turmas • Educação • GEPUB{% endblock %}
{% block header %}Educação{% endblock %}

{% block content %}

{{ nee_labels|json_script:"nee-labels" }}
{{ nee_values|json_script:"nee-values" }}
{{ status_labels|json_script:"st-labels" }}
{{ status_values|json_script:"st-values" }}
{{ evol_labels|json_script:"ev-labels" }}
{{ evol_values|json_script:"ev-values" }}

<div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
  <div>
    <div style="font-weight:1000; font-size:18px;">{{ turma.nome }}</div>
    <div class="small">Turma • {{ turma.ano_letivo }} • {{ turma.turno }}</div>
  </div>

  <div style="display:flex; gap:10px; align-items:center;">
    {% if can_edu_manage %}
      <a class="btn" href="{% url 'educacao:turma_update' turma.pk %}">Editar</a>
    {% endif %}
    <a class="link" href="{% url 'educacao:turma_list' %}">Voltar</a>
  </div>
</div>

<!-- GRID DASHBOARD -->
<div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start;">
  <!-- Card: Informações -->
  <div class="card">
    <div class="card__title">Informações da turma</div>
    <div class="card__body" style="color:var(--text);">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div>
          <div class="small">Ano Letivo</div>
          <div style="font-weight:900;">{{ turma.ano_letivo }}</div>
        </div>
        <div>
          <div class="small">Turno</div>
          <div style="font-weight:900;">{{ turma.turno }}</div>
        </div>

        <div style="grid-column:1/-1;">
          <div class="small">Unidade</div>
          <div style="font-weight:900;">
            <a class="link" href="{% url 'org:unidade_detail' turma.unidade_id %}">{{ turma.unidade.nome }}</a>
          </div>
        </div>

        <div>
          <div class="small">Secretaria</div>
          <div style="font-weight:900;">{{ turma.unidade.secretaria.nome }}</div>
        </div>
        <div>
          <div class="small">Município</div>
          <div style="font-weight:900;">{{ turma.unidade.secretaria.municipio.nome }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card: KPIs rápidos -->
  <div class="card">
    <div class="card__title">Resumo</div>
    <div class="card__body">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">Alunos <strong style="margin-left:6px;">{{ alunos_total }}</strong></span>
        <span class="pill">Professores <strong style="margin-left:6px;">{{ professores_total }}</strong></span>
        <span class="pill">Ativos <strong style="margin-left:6px;">{{ alunos_ativos }}</strong></span>
        <span class="pill">Inativos <strong style="margin-left:6px;">{{ alunos_inativos }}</strong></span>
      </div>

      <div class="small" style="margin-top:10px; opacity:.9;">
        Clique nos blocos abaixo para expandir listas.
      </div>
    </div>
  </div>

  <!-- Card: Gráfico NEE -->
  <div class="card">
    <div class="card__title">Necessidades (NEE) na turma</div>
    <div class="card__body">
      <canvas id="chartNee" height="140"></canvas>
      <div class="small" style="margin-top:6px; opacity:.75;">Distribuição por tipo de necessidade.</div>
    </div>
  </div>

  <!-- Card: Status -->
  <div class="card">
    <div class="card__title">Ativos vs Inativos</div>
    <div class="card__body">
      <canvas id="chartStatus" height="140"></canvas>
      <div class="small" style="margin-top:6px; opacity:.75;">Situação dos alunos matriculados.</div>
    </div>
  </div>

  <!-- Card: Evolução -->
  <div class="card" style="grid-column:1/-1;">
    <div class="card__title">Evolução por ano letivo</div>
    <div class="card__body">
      <canvas id="chartEvol" height="110"></canvas>
      <div class="small" style="margin-top:6px; opacity:.75;">Comparação por ano (mesmo nome de turma e mesma unidade).</div>
    </div>
  </div>

  <!-- Card: Alunos (colapsável) -->
  <div class="card">
    <div class="card__title">Alunos</div>
    <div class="card__body">
      <details>
        <summary style="cursor:pointer; font-weight:900;">
          Ver alunos da turma ({{ alunos_total }})
        </summary>

        <div style="margin-top:10px; overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:14px;">
          <table style="width:100%; border-collapse:collapse; min-width:680px;">
            <thead>
              <tr style="text-align:left; background:rgba(255,255,255,.03);">
                <th style="padding:10px 12px;">Nome</th>
                <th style="padding:10px 12px; width:160px;">CPF</th>
                <th style="padding:10px 12px; width:120px;">Ativo</th>
              </tr>
            </thead>
            <tbody>
              {% for aluno in alunos %}
                <tr style="border-top:1px solid rgba(255,255,255,.06);">
                  <td style="padding:10px 12px;">
                    <a class="link" href="{% url 'educacao:aluno_detail' aluno.pk %}">{{ aluno.nome }}</a>
                  </td>
                  <td style="padding:10px 12px;">{{ aluno.cpf|default:"—" }}</td>
                  <td style="padding:10px 12px;">{% if aluno.ativo %}Sim{% else %}Não{% endif %}</td>
                </tr>
              {% empty %}
                <tr><td colspan="3" style="padding:12px;">Nenhum aluno matriculado nesta turma.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </div>
  </div>

  <!-- Card: Professores (colapsável) -->
  <div class="card">
    <div class="card__title">Professores</div>
    <div class="card__body">
      <details>
        <summary style="cursor:pointer; font-weight:900;">
          Ver professores ({{ professores_total }})
        </summary>

        {% if professores %}
          <div style="margin-top:10px; overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:14px;">
            <table style="width:100%; border-collapse:collapse; min-width:520px;">
              <thead>
                <tr style="text-align:left; background:rgba(255,255,255,.03);">
                  <th style="padding:10px 12px;">Usuário</th>
                  <th style="padding:10px 12px;">Perfil</th>
                </tr>
              </thead>
              <tbody>
                {% for p in professores %}
                  <tr style="border-top:1px solid rgba(255,255,255,.06);">
                    <td style="padding:10px 12px;">{{ p.user.username }}</td>
                    <td style="padding:10px 12px;">{{ p.role }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="small" style="margin-top:10px;">Nenhum professor encontrado (ou perfil não vincula unidade).</div>
        {% endif %}
      </details>
    </div>
  </div>
</div>

<script>
(function () {
  function ensureChartJs(cb) {
    if (window.Chart) return cb();
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
    s.onload = cb;
    s.onerror = function(){ console.warn("Chart.js não carregou."); };
    document.head.appendChild(s);
  }

  function renderCharts() {
    const neeLabels = JSON.parse(document.getElementById("nee-labels").textContent || "[]");
    const neeValues = JSON.parse(document.getElementById("nee-values").textContent || "[]");

    const stLabels = JSON.parse(document.getElementById("st-labels").textContent || "[]");
    const stValues = JSON.parse(document.getElementById("st-values").textContent || "[]");

    const evLabels = JSON.parse(document.getElementById("ev-labels").textContent || "[]");
    const evValues = JSON.parse(document.getElementById("ev-values").textContent || "[]");

    const cNee = document.getElementById("chartNee");
    const cSt  = document.getElementById("chartStatus");
    const cEv  = document.getElementById("chartEvol");
    if (!cNee || !cSt || !cEv || !window.Chart) return;

    // NEE
    if (neeLabels.length && neeValues.length) {
      new Chart(cNee.getContext("2d"), {
        type: "bar",
        data: { labels: neeLabels, datasets: [{ label: "Alunos", data: neeValues, borderWidth: 1 }] },
        options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }

    // Status
    new Chart(cSt.getContext("2d"), {
      type: "doughnut",
      data: { labels: stLabels, datasets: [{ data: stValues, borderWidth: 0 }] },
      options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
    });

    // Evolução
    if (evLabels.length && evValues.length) {
      new Chart(cEv.getContext("2d"), {
        type: "line",
        data: { labels: evLabels, datasets: [{ label: "Alunos", data: evValues, borderWidth: 2, tension: .25 }] },
        options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }
  }

  ensureChartJs(renderCharts);
})();
</script>

{% endblock %}
