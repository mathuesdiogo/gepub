{% extends "core/base.html" %}

{% block content %}
<div class="card"><div class="card__body">
  {% include "core/partials/components/layout/page_head.html" with title=title subtitle=subtitle actions=actions %}

  <form method="get" class="filter-bar" style="margin-bottom:12px;">
    {% if municipios and municipios|length %}
      <select name="municipio" class="input" style="max-width:240px;" onchange="this.form.submit()">
        {% for m in municipios %}
          <option value="{{ m.id }}" {% if municipio and m.id == municipio.id %}selected{% endif %}>{{ m.nome }}/{{ m.uf }}</option>
        {% endfor %}
      </select>
    {% endif %}
  </form>

  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:10px;margin:12px 0 18px;">
    {% for card in cards %}
      {% include "core/partials/components/data/kpi_card.html" with label=card.label value=card.value %}
    {% endfor %}
  </div>

  <div class="table-shell"><div class="table-shell__body">
    <table class="table">
      <thead><tr><th>Número</th><th>Item</th><th>Qtd</th><th>Status</th><th></th></tr></thead>
      <tbody>
        {% for item in latest_reqs %}
          <tr>
            <td>{{ item.numero }}</td>
            <td>{{ item.item.nome }}</td>
            <td>{{ item.quantidade }}</td>
            <td>{{ item.get_status_display }}</td>
            <td>
              {% if item.status == "PENDENTE" %}
                <form method="post" action="{% url 'almoxarifado:requisicao_aprovar' item.pk %}?municipio={{ municipio.pk }}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn btn--sm btn--ghost" type="submit">Aprovar</button>
                </form>
                <form method="post" action="{% url 'almoxarifado:requisicao_atender' item.pk %}?municipio={{ municipio.pk }}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn btn--sm btn-primary" type="submit">Atender</button>
                </form>
              {% elif item.status == "APROVADA" %}
                <form method="post" action="{% url 'almoxarifado:requisicao_atender' item.pk %}?municipio={{ municipio.pk }}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn btn--sm btn-primary" type="submit">Atender</button>
                </form>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5">Sem requisições recentes.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div></div>

  <div class="table-shell" style="margin-top:12px;"><div class="table-shell__body">
    <table class="table">
      <thead><tr><th>Data</th><th>Item</th><th>Tipo</th><th>Qtd</th><th>Documento</th></tr></thead>
      <tbody>
        {% for item in latest_movs %}
          <tr>
            <td>{{ item.data_movimento|date:"d/m/Y" }}</td>
            <td>{{ item.item.nome }}</td>
            <td>{{ item.get_tipo_display }}</td>
            <td>{{ item.quantidade }}</td>
            <td>{{ item.documento|default:"-" }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="5">Sem movimentos registrados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div></div>
</div></div>
{% endblock %}
