{% load static %}

<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}GEPUB{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  {% block extra_css %}{% endblock %}
</head>
<body class="theme-institucional">
  <div class="layout">
    <aside class="sidebar" aria-label="Menu lateral">
      <div class="sidebar__header">
        <div class="brand">
          <div class="brand__logo" aria-hidden="true">
            <i class="fa-solid fa-cube"></i>
          </div>
          <div class="brand__text">
            <div class="brand__name">GEPUB</div>
            <div class="brand__sub">Gestão Estratégica Pública</div>
          </div>
        </div>
        <button
          type="button"
          class="sidebar__toggle"
          id="sidebarToggle"
          aria-label="Recolher menu"
          aria-pressed="false"
          title="Recolher menu"
        >
          <i class="fa-solid fa-bars"></i>
        </button>
      </div>

      {% with rm=request.resolver_match %}{% include "core/partials/components/layout/sidebar_navigation.html" %}{% endwith %}

      <div class="sidebar__footer">
        <div class="sidebar__footer-tools">
          <a class="sidebar__footer-btn" href="{% url 'core:guia_telas' %}" title="Ajuda - Guia de telas" aria-label="Ajuda - Guia de telas">
            <i class="fa-solid fa-circle-question" aria-hidden="true"></i>
          </a>
          <a class="sidebar__footer-btn sidebar__footer-btn--danger" href="{% url 'accounts:logout' %}" title="Sair" aria-label="Sair">
            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
          </a>
        </div>
      </div>
    </aside>

    <main class="main" id="conteudo">
      <header class="topbar">
        <div class="topbar__left">
          <div class="topbar__title">{% block header %}Dashboard{% endblock %}</div>
          {% block breadcrumbs %}{% if breadcrumbs %}{% include "core/partials/components/layout/breadcrumbs.html" with items=breadcrumbs %}{% endif %}{% endblock %}
        </div>

        <div class="topbar__right">
          <form class="topbar-search" method="get" action="{% url 'core:go_code' %}">
            <label class="topbar-search__label" for="topbarCodeSearch">Buscar</label>
            <i class="fa-solid fa-magnifying-glass topbar-search__icon" aria-hidden="true"></i>
            <input
              id="topbarCodeSearch"
              class="topbar-search__input"
              type="text"
              name="c"
              inputmode="numeric"
              autocomplete="off"
              placeholder="Pesquisar por código ou tela..."
            />
            <button class="topbar-search__btn" type="submit" aria-label="Pesquisar">
              <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
            </button>
          </form>

          {% with display_name=request.user.get_full_name|default:request.user.username user_role=request.user.groups.first.name|default:"Usuário" %}
            <a class="topbar-user" href="{% url 'accounts:meu_perfil' %}">
              <span class="topbar-user__avatar">
                {% if request.user.is_authenticated %}
                  {{ display_name|slice:":1"|upper }}
                {% else %}
                  V
                {% endif %}
              </span>
              <span class="topbar-user__info">
                <span class="topbar-user__name">{{ display_name|default:"Visitante" }}</span>
                <span class="topbar-user__role">{{ user_role }}</span>
              </span>
            </a>
          {% endwith %}
        </div>
      </header>

      <section class="content">
        {% if messages %}
          <div class="alert-stack">
            {% for message in messages %}
              <div class="alert alert--{{ message.tags }}">
                {{ message }}
                <button type="button" class="alert__close" aria-label="Fechar">&times;</button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
        {% block content %}{% endblock %}
      </section>
    </main>
  </div>

  <script src="{% static 'js/autocomplete.js' %}"></script>
  <script>
    (function () {
      const key = "gepub.sidebar.collapsed";
      const btn = document.getElementById("sidebarToggle");

      function applySidebarState(state) {
        document.body.classList.toggle("sidebar-collapsed", state);
        if (btn) {
          btn.setAttribute("aria-pressed", state ? "true" : "false");
          btn.setAttribute("aria-label", state ? "Expandir menu" : "Recolher menu");
          btn.title = state ? "Expandir menu" : "Recolher menu";
        }
      }

      function setupSidebar() {
        const saved = localStorage.getItem(key);
        applySidebarState(saved === "1");
        if (!btn) return;
        btn.addEventListener("click", function () {
          const next = !document.body.classList.contains("sidebar-collapsed");
          localStorage.setItem(key, next ? "1" : "0");
          applySidebarState(next);
        });
      }

      function closeAlert(alert) {
        if (!alert) return;
        alert.classList.add("alert--closing");
        setTimeout(function () {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 250);
      }

      function setupAlerts() {
        document.addEventListener("click", function (e) {
          const close = e.target.closest(".alert__close");
          if (!close) return;
          closeAlert(close.closest(".alert"));
        });

        document.querySelectorAll(".alert").forEach(function (alert) {
          setTimeout(function () {
            if (!alert.parentNode) return;
            closeAlert(alert);
          }, 4000);
        });
      }

      function setupActionMenus() {
        document.addEventListener("click", function () {
          document.querySelectorAll(".action-menu").forEach(function (menu) {
            menu.classList.remove("action-menu--open");
          });
        });

        document.addEventListener("click", function (e) {
          const menuButton = e.target.closest(".action-menu__button");
          if (!menuButton) return;
          e.preventDefault();
          e.stopPropagation();
          const menu = menuButton.closest(".action-menu");
          if (!menu) return;
          menu.classList.toggle("action-menu--open");
        });
      }

      function boot() {
        setupSidebar();
        setupAlerts();
        setupActionMenus();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", boot);
      } else {
        boot();
      }
    })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>
