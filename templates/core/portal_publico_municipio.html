{% extends "core/base_public.html" %}
{% load static %}

{% block title %}{{ municipio.nome }} • Portal Público GEPUB{% endblock %}

{% block extra_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Sora:wght@500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/pages/portal-publico-municipio.css' %}">
{% endblock %}

{% block content %}
<div class="city-page {% if request.GET.portal_editor == '1' %}city-page--editor{% endif %}" style="--portal-primary: {{ cor_primaria|default:'#0E4A7E' }}; --portal-secondary: {{ cor_secundaria|default:'#2F6EA9' }};">
  <header class="city-header">
    <div class="city-topbar">
      <div class="city-wrap city-topbar__inner">
        <a href="{% url 'core:home' %}" class="city-brand">
          {% if portal_cfg.logo %}
            <img src="{{ portal_cfg.logo.url }}" alt="{{ municipio.nome }}">
          {% else %}
            <span class="city-brand__icon"><i class="fa-solid fa-building-columns"></i></span>
          {% endif %}
          <span>
            <strong
              data-theme-bind="titulo_portal"
              data-theme-editable="titulo_portal"
              {% if request.GET.portal_editor == "1" %}contenteditable="true"{% endif %}
            >{{ portal_cfg.titulo_portal|default:municipio.nome|upper }}</strong>
            <small
              data-theme-bind="subtitulo_portal"
              data-theme-editable="subtitulo_portal"
              {% if request.GET.portal_editor == "1" %}contenteditable="true"{% endif %}
            >{{ portal_cfg.subtitulo_portal|default:"GOVERNO PARA O POVO" }}</small>
          </span>
        </a>

        <nav class="city-quick-links" aria-label="Links rápidos do portal">
          {% for item in top_links %}
            <a href="{{ item.url }}" {% if "http" in item.url %}target="_blank" rel="noopener"{% endif %}>
              <i class="{{ item.icon }}"></i>
              <span>{{ item.titulo }}</span>
            </a>
          {% endfor %}
        </nav>
      </div>
    </div>

    <div class="city-mainnav">
      <div class="city-wrap city-mainnav__inner">
        <nav class="city-menu" aria-label="Navegação principal">
          {% for item in menu_items_header|slice:":8" %}
            {% with item_key=item.titulo|lower %}
              <a href="{{ item.url }}" {% if item.nova_aba %}target="_blank" rel="noopener"{% endif %} class="city-menu__item {% if request.path == item.url %}is-active{% endif %}">
                {% if "início" in item_key or "inicio" in item_key %}
                  <i class="fa-solid fa-house"></i>
                {% elif "prefeitura" in item_key %}
                  <i class="fa-solid fa-building"></i>
                {% elif "transpar" in item_key %}
                  <i class="fa-solid fa-chart-column"></i>
                {% elif "servi" in item_key %}
                  <i class="fa-solid fa-users"></i>
                {% elif "not" in item_key %}
                  <i class="fa-regular fa-newspaper"></i>
                {% elif "diário" in item_key or "diario" in item_key %}
                  <i class="fa-regular fa-file-lines"></i>
                {% elif "ouv" in item_key %}
                  <i class="fa-regular fa-message"></i>
                {% elif "cont" in item_key %}
                  <i class="fa-solid fa-phone"></i>
                {% else %}
                  <i class="fa-solid fa-circle-dot"></i>
                {% endif %}
                <span>{{ item.titulo }}</span>
              </a>
            {% endwith %}
          {% endfor %}
        </nav>
      </div>
    </div>
  </header>

  <main id="conteudo-principal" class="city-main">
    <section class="city-hero {% if hero_image_url %}city-hero--image{% endif %}" data-theme-action="banner_imagem" {% if hero_image_url %}style="--hero-image:url('{{ hero_image_url }}');"{% endif %}>
      <div class="city-wrap">
        <div class="city-hero__content">
          {% if banners_home|length %}
            <p class="city-hero__banner-title" data-theme-bind="banner_titulo">{{ banners_home.0.titulo }}</p>
            {% if banners_home.0.subtitulo %}
              <p class="city-hero__banner-subtitle" data-theme-bind="banner_subtitulo">{{ banners_home.0.subtitulo }}</p>
            {% endif %}
          {% endif %}
          <h1>Transparência e Compromisso com o Cidadão</h1>
          <p
            data-theme-bind="mensagem_boas_vindas"
            data-theme-editable="mensagem_boas_vindas"
            {% if request.GET.portal_editor == "1" %}contenteditable="true"{% endif %}
          >{{ portal_cfg.mensagem_boas_vindas|default:"Acesse informações, serviços e acompanhe a gestão do seu município de forma simples e transparente." }}</p>
          <div class="city-hero__actions">
            <a class="city-btn city-btn--primary" href="{{ cta_transparencia }}">Acessar Transparência</a>
            <a class="city-btn city-btn--success" href="{{ cta_servicos_online }}">Serviços Online</a>
          </div>
        </div>
      </div>
    </section>

    <section class="city-shortcuts">
      <div class="city-wrap">
        <div class="city-shortcuts__grid">
          {% for item in servicos_destaque %}
            <a class="city-shortcut-card" href="{{ item.url|default:'#' }}">
              <span class="city-shortcut-card__icon"><i class="{{ item.icon|default:'fa-solid fa-circle-info' }}"></i></span>
              <strong>{{ item.titulo }}</strong>
            </a>
          {% endfor %}
        </div>
      </div>
    </section>

    {% if noticias_home %}
      <section class="city-section">
        <div class="city-wrap">
          <h2 class="city-section__title">Últimas Notícias</h2>
          <div class="city-news-grid">
            {% for item in noticias_home %}
              <article class="city-news-card">
                <a href="{% url 'core:portal_noticia_detail_public' item.slug %}">
                  <div class="city-news-card__media">
                    {% if item.imagem %}
                      <img src="{{ item.imagem.url }}" alt="{{ item.titulo }}">
                    {% else %}
                      <span><i class="fa-regular fa-image"></i></span>
                    {% endif %}
                  </div>
                  <div class="city-news-card__body">
                    <h3>{{ item.titulo }}</h3>
                    <div class="city-news-card__meta">
                      <span>{{ item.publicado_em|date:"d/m/Y" }}</span>
                      <span>Leia mais <i class="fa-solid fa-arrow-right"></i></span>
                    </div>
                  </div>
                </a>
              </article>
            {% endfor %}
          </div>
        </div>
      </section>
    {% endif %}

    <section class="city-section">
      <div class="city-wrap">
        <h2 class="city-section__title">Painel de Transparência</h2>
        <div class="city-kpi-grid">
          {% for item in transparencia_cards %}
            <article class="city-kpi-card city-kpi-card--{{ item.cor }}">
              <p><i class="{{ item.icone }}"></i> {{ item.titulo }}</p>
              <strong>{{ item.valor }}</strong>
              <span>{{ item.subtitulo }}</span>
            </article>
          {% endfor %}
        </div>
      </div>
    </section>

    <section class="city-section city-section--services">
      <div class="city-wrap">
        <h2 class="city-section__title">Serviços Online</h2>
        <div class="city-services-grid">
          {% for item in servicos_cards %}
            <a class="city-service-card" href="{{ item.url|default:'#' }}">
              <span class="city-service-card__icon"><i class="{{ item.icon|default:'fa-solid fa-circle-info' }}"></i></span>
              <h3
                data-theme-bind="bloco_{{ forloop.counter0 }}_titulo"
                data-theme-editable="bloco_{{ forloop.counter0 }}_titulo"
                {% if request.GET.portal_editor == "1" %}contenteditable="true"{% endif %}
              >{{ item.titulo }}</h3>
              <p
                data-theme-bind="bloco_{{ forloop.counter0 }}_descricao"
                data-theme-editable="bloco_{{ forloop.counter0 }}_descricao"
                {% if request.GET.portal_editor == "1" %}contenteditable="true"{% endif %}
              >{{ item.descricao|default:"Serviço online disponível no portal público municipal." }}</p>
            </a>
          {% endfor %}
        </div>
      </div>
    </section>
  </main>

  <footer class="city-footer">
    <div class="city-wrap">
      <div class="city-footer__grid">
        <article>
          <h3><i class="fa-solid fa-location-dot"></i> Endereço</h3>
          <p data-theme-bind="endereco">{{ portal_cfg.endereco|default:"Endereço não informado." }}</p>
        </article>
        <article>
          <h3><i class="fa-solid fa-phone"></i> Telefone</h3>
          <p data-theme-bind="telefone">{{ portal_cfg.telefone|default:"Telefone não informado." }}</p>
        </article>
        <article>
          <h3><i class="fa-solid fa-id-card"></i> Município</h3>
          <p>{{ municipio.nome }}{% if municipio.uf %} - {{ municipio.uf }}{% endif %}</p>
        </article>
        <article>
          <h3><i class="fa-regular fa-clock"></i> Atendimento</h3>
          <p data-theme-bind="horario_atendimento">{{ portal_cfg.horario_atendimento|default:"Horário não informado." }}</p>
        </article>
      </div>

      <div class="city-footer__bottom">
        <div class="city-footer__links">
          {% for item in menu_items_footer|slice:":6" %}
            <a href="{{ item.url }}" {% if item.nova_aba %}target="_blank" rel="noopener"{% endif %}>{{ item.titulo }}</a>
          {% endfor %}
        </div>
        <p>© {% now "Y" %} {{ municipio.nome }} • Portal Público Municipal</p>
      </div>
    </div>
  </footer>
</div>
{% if request.GET.portal_editor == "1" %}
<script>
  (function () {
    var page = document.querySelector(".city-page");
    if (!page) return;

    function cleanText(value) {
      return String(value || "").replace(/\\s+/g, " ").trim();
    }

    function bindSet(field, value) {
      document.querySelectorAll("[data-theme-bind='" + field + "']").forEach(function (el) {
        if (typeof value === "string") {
          el.textContent = value || el.textContent;
        }
      });
    }

    window.addEventListener("message", function (event) {
      var data = event.data || {};
      if (data.type !== "portal-theme:preview-update") return;
      var payload = data.payload || {};

      if (payload.cor_primaria) {
        page.style.setProperty("--portal-primary", payload.cor_primaria);
      }
      if (payload.cor_secundaria) {
        page.style.setProperty("--portal-secondary", payload.cor_secundaria);
      }

      Object.keys(payload).forEach(function (field) {
        bindSet(field, payload[field]);
      });
    });

    document.querySelectorAll("[data-theme-editable]").forEach(function (el) {
      var field = el.getAttribute("data-theme-editable");
      if (!field) return;
      el.addEventListener("blur", function () {
        window.parent.postMessage(
          { type: "portal-theme:field-edit", field: field, value: cleanText(el.textContent) },
          "*"
        );
      });
      el.addEventListener("keydown", function (ev) {
        if (ev.key === "Enter") {
          ev.preventDefault();
          el.blur();
        }
      });
    });

    document.querySelectorAll("[data-theme-action='banner_imagem']").forEach(function (el) {
      el.addEventListener("click", function () {
        window.parent.postMessage({ type: "portal-theme:focus", field: "banner_imagem" }, "*");
      });
    });

    document.querySelectorAll("a").forEach(function (link) {
      link.addEventListener("click", function (ev) {
        ev.preventDefault();
      });
    });
  })();
</script>
{% endif %}
{% endblock %}
