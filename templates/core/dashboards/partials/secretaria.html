<div class="admin-dash">
  <div class="dash-actions admin-dash__actions">
    <a class="btn btn-primary" href="{% url 'org:unidade_list' %}"><i class="fa-solid fa-school"></i> Unidades</a>
    <a class="btn btn-primary" href="{% url 'educacao:turma_list' %}"><i class="fa-solid fa-people-group"></i> Turmas</a>
    <a class="btn btn-primary" href="{% url 'educacao:aluno_list' %}"><i class="fa-solid fa-user-graduate"></i> Alunos</a>
  </div>

  <div class="dash-kpi-grid">
    <a class="admin-kpi admin-kpi--green" href="{% url 'org:unidade_list' %}">
      <div class="admin-kpi__icon"><i class="fa-solid fa-school"></i></div>
      <div class="admin-kpi__content">
        <div class="admin-kpi__label">Unidades</div>
        <div class="admin-kpi__value">{{ unidades_total|default:0 }}</div>
        <div class="admin-kpi__meta">Unidades vinculadas à secretaria</div>
      </div>
    </a>

    <a class="admin-kpi admin-kpi--slate" href="{% url 'educacao:turma_list' %}">
      <div class="admin-kpi__icon"><i class="fa-solid fa-people-group"></i></div>
      <div class="admin-kpi__content">
        <div class="admin-kpi__label">Turmas</div>
        <div class="admin-kpi__value">{{ turmas_total|default:0 }}</div>
        <div class="admin-kpi__meta">Turmas ativas e históricas</div>
      </div>
    </a>

    <a class="admin-kpi admin-kpi--amber" href="{% url 'educacao:aluno_list' %}">
      <div class="admin-kpi__icon"><i class="fa-solid fa-user-graduate"></i></div>
      <div class="admin-kpi__content">
        <div class="admin-kpi__label">Alunos</div>
        <div class="admin-kpi__value">{{ alunos_total|default:0 }}</div>
        <div class="admin-kpi__meta">Cadastros na secretaria</div>
      </div>
    </a>
  </div>

  <div class="dash-panel-grid dash-panel-grid--main">
    <section class="admin-panel">
      <div class="admin-panel__head">
        <div>
          <h3 class="admin-panel__title">Top unidades por turmas</h3>
          <p class="admin-panel__sub">Visão das unidades com maior quantidade de turmas</p>
        </div>
      </div>

      {% if graf_turmas_por_unidade %}
        <div class="admin-ranking">
          {% for row in graf_turmas_por_unidade %}
            {% if row.unidade_id %}
              <a class="admin-ranking__row" href="{% url 'org:unidade_detail' row.unidade_id %}">
                <div class="admin-ranking__head">
                  <span class="admin-ranking__name">{{ row.unidade__nome }}</span>
                  <span class="admin-ranking__value">{{ row.total }} turmas</span>
                </div>
                <div class="admin-meter" data-value="{{ row.total }}" aria-hidden="true"><span class="admin-meter__fill"></span></div>
              </a>
            {% else %}
              <div class="admin-ranking__row">
                <div class="admin-ranking__head">
                  <span class="admin-ranking__name">{{ row.unidade__nome }}</span>
                  <span class="admin-ranking__value">{{ row.total }} turmas</span>
                </div>
                <div class="admin-meter" data-value="{{ row.total }}" aria-hidden="true"><span class="admin-meter__fill"></span></div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        {% include "core/partials/components/feedback/empty_state.html" with title="Sem dados" text="Ainda não há turmas suficientes para montar o ranking." %}
      {% endif %}
    </section>

    <section class="admin-panel">
      <div class="admin-panel__head">
        <div>
          <h3 class="admin-panel__title">Minhas unidades</h3>
          <p class="admin-panel__sub">Unidades sob gestão da secretaria</p>
        </div>
        <a class="btn btn--ghost" href="{% url 'org:unidade_list' %}"><i class="fa-solid fa-list"></i> Ver todas</a>
      </div>

      {% if unidades %}
        <div class="admin-table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Unidade</th>
                <th>Tipo</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody>
              {% for u in unidades %}
                <tr>
                  <td>{{ u.nome }}</td>
                  <td>{{ u.get_tipo_display|default:"—" }}</td>
                  <td><a class="btn btn--ghost" href="{% url 'org:unidade_detail' u.pk %}"><i class="fa-solid fa-arrow-up-right-from-square"></i> Abrir</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        {% include "core/partials/components/feedback/empty_state.html" with title="Nenhuma unidade" text="Esta secretaria ainda não possui unidades vinculadas." %}
      {% endif %}
    </section>
  </div>

  <section class="admin-panel">
    <div class="admin-panel__head">
      <div>
        <h3 class="admin-panel__title">Resumo executivo</h3>
        <p class="admin-panel__sub">Indicadores principais da secretaria</p>
      </div>
    </div>

    <div class="dash-kpi-grid">
      <a class="admin-kpi admin-kpi--green" href="{% url 'org:unidade_list' %}">
        <div class="admin-kpi__icon"><i class="fa-solid fa-school"></i></div>
        <div class="admin-kpi__content">
          <div class="admin-kpi__label">Unidades cadastradas</div>
          <div class="admin-kpi__value">{{ unidades_total|default:0 }}</div>
        </div>
      </a>
      <a class="admin-kpi admin-kpi--slate" href="{% url 'educacao:turma_list' %}">
        <div class="admin-kpi__icon"><i class="fa-solid fa-people-group"></i></div>
        <div class="admin-kpi__content">
          <div class="admin-kpi__label">Turmas cadastradas</div>
          <div class="admin-kpi__value">{{ turmas_total|default:0 }}</div>
        </div>
      </a>
      <a class="admin-kpi admin-kpi--amber" href="{% url 'educacao:aluno_list' %}">
        <div class="admin-kpi__icon"><i class="fa-solid fa-user-graduate"></i></div>
        <div class="admin-kpi__content">
          <div class="admin-kpi__label">Alunos cadastrados</div>
          <div class="admin-kpi__value">{{ alunos_total|default:0 }}</div>
        </div>
      </a>
    </div>
  </section>
</div>

<script>
(function () {
  function applyMeters(selector) {
    var meters = Array.prototype.slice.call(document.querySelectorAll(selector));
    if (!meters.length) return;

    var maxValue = meters.reduce(function (acc, meter) {
      var value = Number(meter.getAttribute("data-value") || 0);
      return value > acc ? value : acc;
    }, 0);

    meters.forEach(function (meter) {
      var value = Number(meter.getAttribute("data-value") || 0);
      var width = maxValue > 0 ? (value / maxValue) * 100 : 0;
      var fill = meter.querySelector(".admin-meter__fill");
      if (fill) {
        fill.style.width = width + "%";
      }
    });
  }

  applyMeters(".admin-meter");
})();
</script>
