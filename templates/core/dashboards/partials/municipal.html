{% load static %}

<div class="admin-dash">
  <div class="dash-actions admin-dash__actions">
    <a class="btn btn-primary" href="{% url 'org:secretaria_list' %}"><i class="fa-solid fa-building-columns"></i> Secretarias</a>
    <a class="btn btn-primary" href="{% url 'org:unidade_list' %}"><i class="fa-solid fa-school"></i> Unidades</a>
    <a class="btn btn-primary" href="{% url 'educacao:aluno_list' %}"><i class="fa-solid fa-user-graduate"></i> Alunos</a>
    <a class="btn btn-primary" href="{{ onboarding_url }}"><i class="fa-solid fa-list-check"></i> Onboarding</a>
  </div>

  <div class="dash-kpi-grid">
    <a class="admin-kpi admin-kpi--blue" href="{% url 'org:secretaria_list' %}">
      <div class="admin-kpi__icon"><i class="fa-solid fa-building-columns"></i></div>
      <div class="admin-kpi__content">
        <div class="admin-kpi__label">Secretarias</div>
        <div class="admin-kpi__value">{{ secretarias_total|default:0 }}</div>
        <div class="admin-kpi__meta">Estrutura municipal ativa</div>
      </div>
    </a>

    <a class="admin-kpi admin-kpi--green" href="{% url 'org:unidade_list' %}">
      <div class="admin-kpi__icon"><i class="fa-solid fa-school"></i></div>
      <div class="admin-kpi__content">
        <div class="admin-kpi__label">Unidades</div>
        <div class="admin-kpi__value">{{ unidades_total|default:0 }}</div>
        <div class="admin-kpi__meta">Rede de ensino vinculada</div>
      </div>
    </a>

    <a class="admin-kpi admin-kpi--slate" href="{% url 'educacao:turma_list' %}">
      <div class="admin-kpi__icon"><i class="fa-solid fa-people-group"></i></div>
      <div class="admin-kpi__content">
        <div class="admin-kpi__label">Turmas</div>
        <div class="admin-kpi__value">{{ turmas_total|default:0 }}</div>
        <div class="admin-kpi__meta">Turmas do município</div>
      </div>
    </a>

    <a class="admin-kpi admin-kpi--amber" href="{% url 'educacao:aluno_list' %}">
      <div class="admin-kpi__icon"><i class="fa-solid fa-user-graduate"></i></div>
      <div class="admin-kpi__content">
        <div class="admin-kpi__label">Alunos</div>
        <div class="admin-kpi__value">{{ alunos_total|default:0 }}</div>
        <div class="admin-kpi__meta">Alunos matriculados</div>
      </div>
    </a>

    <a class="admin-kpi admin-kpi--slate" href="{% url 'educacao:matricula_create' %}">
      <div class="admin-kpi__icon"><i class="fa-solid fa-id-card-clip"></i></div>
      <div class="admin-kpi__content">
        <div class="admin-kpi__label">Matrículas</div>
        <div class="admin-kpi__value">{{ matriculas_total|default:0 }}</div>
        <div class="admin-kpi__meta">Vínculos ativos e históricos</div>
      </div>
    </a>

    <a class="admin-kpi admin-kpi--blue" href="{{ onboarding_url }}">
      <div class="admin-kpi__icon"><i class="fa-solid fa-list-check"></i></div>
      <div class="admin-kpi__content">
        <div class="admin-kpi__label">Onboarding</div>
        <div class="admin-kpi__value">{{ onboarding_done_steps|default:0 }}/{{ onboarding_total_steps|default:0 }}</div>
        <div class="admin-kpi__meta">{{ onboarding_modules_active|default:0 }} módulos ativos</div>
      </div>
    </a>
  </div>

  <div class="dash-panel-grid">
    <section class="admin-panel">
      <div class="admin-panel__head">
        <div>
          <h3 class="admin-panel__title">Unidades por secretaria</h3>
          <p class="admin-panel__sub">Top secretarias por volume de unidades</p>
        </div>
      </div>
      {% if chart1_labels %}
        <div class="admin-line-wrap">
          <canvas id="chartUnidadesSecretaria" height="220"></canvas>
        </div>
      {% else %}
        {% include "core/partials/components/feedback/empty_state.html" with title="Sem dados" text="Ainda não há dados de unidades por secretaria." %}
      {% endif %}
    </section>

    <section class="admin-panel">
      <div class="admin-panel__head">
        <div>
          <h3 class="admin-panel__title">Alunos por secretaria</h3>
          <p class="admin-panel__sub">Top secretarias por alunos matriculados</p>
        </div>
      </div>
      {% if chart2_labels %}
        <div class="admin-line-wrap">
          <canvas id="chartAlunosSecretaria" height="220"></canvas>
        </div>
      {% else %}
        {% include "core/partials/components/feedback/empty_state.html" with title="Sem dados" text="Ainda não há dados de alunos por secretaria." %}
      {% endif %}
    </section>
  </div>

  <div class="dash-panel-grid">
    <section class="admin-panel">
      <div class="admin-panel__head">
        <div>
          <h3 class="admin-panel__title">Últimas secretarias</h3>
          <p class="admin-panel__sub">Cadastros recentes do município</p>
        </div>
        <a class="btn btn--ghost" href="{% url 'org:secretaria_list' %}"><i class="fa-solid fa-list"></i> Ver todas</a>
      </div>

      {% if ultimas_secretarias %}
        <div class="admin-table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Secretaria</th>
                <th>Município</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody>
              {% for s in ultimas_secretarias %}
                <tr>
                  <td>{{ s.nome }}</td>
                  <td>{{ s.municipio.nome|default:"—" }}</td>
                  <td><a class="btn btn--ghost" href="{% url 'org:secretaria_detail' s.pk %}"><i class="fa-solid fa-arrow-up-right-from-square"></i> Abrir</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        {% include "core/partials/components/feedback/empty_state.html" with title="Sem secretarias" text="Ainda não há secretarias cadastradas." %}
      {% endif %}
    </section>

    <section class="admin-panel">
      <div class="admin-panel__head">
        <div>
          <h3 class="admin-panel__title">Últimos alunos</h3>
          <p class="admin-panel__sub">Cadastros recentes de alunos</p>
        </div>
        <a class="btn btn--ghost" href="{% url 'educacao:aluno_list' %}"><i class="fa-solid fa-list"></i> Ver todos</a>
      </div>

      {% if ultimos_alunos %}
        <div class="admin-table-wrap">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Aluno</th>
                <th>Turma/Unidade</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody>
              {% for a in ultimos_alunos %}
                <tr>
                  <td>{{ a.nome }}</td>
                  <td>
                    {% if a.matriculas.all %}
                      {% with m=a.matriculas.all.0 %}
                        {{ m.turma.nome }} • {{ m.turma.unidade.nome }}
                      {% endwith %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td><a class="btn btn--ghost" href="{% url 'educacao:aluno_detail' a.pk %}"><i class="fa-solid fa-arrow-up-right-from-square"></i> Abrir</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        {% include "core/partials/components/feedback/empty_state.html" with title="Sem alunos" text="Ainda não há alunos cadastrados." %}
      {% endif %}
    </section>
  </div>
</div>

{{ chart1_labels|json_script:"chart1-labels" }}
{{ chart1_values|json_script:"chart1-values" }}
{{ chart2_labels|json_script:"chart2-labels" }}
{{ chart2_values|json_script:"chart2-values" }}

<script>
(function () {
  function loadChart(cb) {
    if (window.Chart) return cb();
    var script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
    script.onload = cb;
    document.head.appendChild(script);
  }

  loadChart(function () {
    var labels1 = JSON.parse(document.getElementById("chart1-labels").textContent || "[]");
    var values1 = JSON.parse(document.getElementById("chart1-values").textContent || "[]");
    var labels2 = JSON.parse(document.getElementById("chart2-labels").textContent || "[]");
    var values2 = JSON.parse(document.getElementById("chart2-values").textContent || "[]");

    var chart1 = document.getElementById("chartUnidadesSecretaria");
    if (chart1 && labels1.length) {
      new Chart(chart1, {
        type: "bar",
        data: {
          labels: labels1,
          datasets: [{
            data: values1,
            backgroundColor: "rgba(31,95,191,0.85)",
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }

    var chart2 = document.getElementById("chartAlunosSecretaria");
    if (chart2 && labels2.length) {
      new Chart(chart2, {
        type: "bar",
        data: {
          labels: labels2,
          datasets: [{
            data: values2,
            backgroundColor: "rgba(5,150,105,0.85)",
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }
  });
})();
</script>
