<form method="get" class="filter-bar" action="{{ action_url|default:'' }}">
  <div class="filter-bar__field">
    <label class="small">Buscar</label>
    <input
      name="q"
      value="{{ q|default:'' }}"
      placeholder="Digite para buscar..."
      {% if autocomplete_url %}data-autocomplete-url="{{ autocomplete_url }}"{% endif %}
      autocomplete="off"
    />
    <div class="filter-bar__autocomplete" data-autocomplete-list hidden></div>
  </div>

  {% if extra_filters %}
    {{ extra_filters|safe }}
  {% endif %}

  <div class="filter-bar__actions">
    <button class="btn btn--ghost" type="submit">
      <i class="fa-solid fa-filter" aria-hidden="true"></i>
      <span>Filtrar</span>
    </button>

    {% if clear_url %}
      <a class="btn btn--ghost" href="{{ clear_url }}">
        <i class="fa-solid fa-rotate-left" aria-hidden="true"></i>
        <span>Limpar</span>
      </a>
    {% endif %}
  </div>
</form>

{% if autocomplete_url %}
<script>
(function () {
  const input = document.querySelector('.filter-bar input[name="q"][data-autocomplete-url]');
  if (!input) return;

  const box = input.parentElement.querySelector('[data-autocomplete-list]');
  if (!box) return;

  const url = input.getAttribute('data-autocomplete-url');
  let t = null;

  function closeBox() {
    box.hidden = true;
    box.innerHTML = '';
  }

  function openBox(items) {
    if (!items || !items.length) { closeBox(); return; }

    box.hidden = false;
    box.innerHTML = items.map(it => {
      const label = (it.nome || it.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const meta = (it.cpf || it.nis || it.meta || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const val = (it.nome || it.text || '').replace(/"/g,'&quot;');

      return `
        <button type="button" class="filter-bar__autocomplete-item" data-value="${val}">
          <div class="filter-bar__autocomplete-title">${label}</div>
          ${meta ? `<div class="filter-bar__autocomplete-meta">${meta}</div>` : ``}
        </button>
      `;
    }).join('');

    box.querySelectorAll('[data-value]').forEach(btn => {
      btn.addEventListener('click', () => {
        input.value = btn.getAttribute('data-value') || '';
        closeBox();
        input.form && input.form.submit();
      });
    });
  }

  async function fetchItems(q) {
    const u = new URL(url, window.location.origin);
    u.searchParams.set('q', q);

    const res = await fetch(u.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
    const data = await res.json();
    return data.results || [];
  }

  input.addEventListener('input', () => {
    const q = (input.value || '').trim();
    clearTimeout(t);

    if (q.length < 2) { closeBox(); return; }

    t = setTimeout(async () => {
      try {
        const items = await fetchItems(q);
        openBox(items);
      } catch (e) {
        closeBox();
      }
    }, 250);
  });

  input.addEventListener('blur', () => {
    setTimeout(closeBox, 150);
  });

  input.addEventListener('focus', () => {
    const q = (input.value || '').trim();
    if (q.length >= 2) input.dispatchEvent(new Event('input'));
  });
})();
</script>
{% endif %}
