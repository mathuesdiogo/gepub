{% extends "core/base.html" %}
{% block title %}Dashboard • Secretaria • GEPUB{% endblock %}
{% block header %}Dashboard{% endblock %}

{% block content %}

<div class="sec-dashboard">

  <div class="card">
    <div class="card__title" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <span>Secretaria </span>
      <span class="pill">Acompanhe aqui o movimento mensal</span>
    </div>
    <div class="card__body">

      <!-- ===== KPIs coloridos (clicáveis) ===== -->
      <div class="sec-metrics">

        <a class="sec-kpi kpi-green" href="{% url 'org:unidade_list' %}">
          <div>
            <div class="sec-kpi__label">Unidades</div>
            <div class="sec-kpi__value">{{ unidades_total }}</div>
            <div class="sec-kpi__meta">Ver unidades</div>
          </div>
          <div class="sec-kpi__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M3 10.5 12 3l9 7.5v9a1.5 1.5 0 0 1-1.5 1.5H15v-6H9v6H4.5A1.5 1.5 0 0 1 3 19.5v-9Z"/>
            </svg>
          </div>
        </a>

        <a class="sec-kpi kpi-blue" href="{% url 'educacao:turma_list' %}">
          <div>
            <div class="sec-kpi__label">Turmas</div>
            <div class="sec-kpi__value">{{ turmas_total }}</div>
            <div class="sec-kpi__meta">Ver turmas</div>
          </div>
          <div class="sec-kpi__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M4 5.5A2.5 2.5 0 0 1 6.5 3h11A2.5 2.5 0 0 1 20 5.5v13A2.5 2.5 0 0 1 17.5 21h-11A2.5 2.5 0 0 1 4 18.5v-13ZM8 7h8v2H8V7Zm0 4h8v2H8v-2Zm0 4h5v2H8v-2Z"/>
            </svg>
          </div>
        </a>

        <a class="sec-kpi kpi-purple" href="{% url 'educacao:aluno_list' %}">
          <div>
            <div class="sec-kpi__label">Alunos</div>
            <div class="sec-kpi__value">{{ alunos_total }}</div>
            <div class="sec-kpi__meta">Ver alunos</div>
          </div>
          <div class="sec-kpi__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M12 12a4.5 4.5 0 1 0-4.5-4.5A4.5 4.5 0 0 0 12 12Zm0 2c-4.1 0-8 2.1-8 5v1h16v-1c0-2.9-3.9-5-8-5Z"/>
            </svg>
          </div>
        </a>

      </div>

      <!-- ===== GRID principal ===== -->
      <div class="sec-grid">

        <!-- COLUNA ESQUERDA: Top 8 + Minhas unidades -->
        <div class="sec-stack">

          <!-- Top 8 (compacto e clicável) -->
          <div class="sec-chart-box">
            <div class="sec-card-title">
              <h3>Ver unidades do Top 8</h3>
              <span class="sec-pill">Top 8</span>
            </div>

            {% if graf_turmas_por_unidade %}
              <div class="sec-list">
                {% for row in graf_turmas_por_unidade %}
                  {% if row.unidade_id %}
                    <a class="sec-row" href="{% url 'org:unidade_detail' row.unidade_id %}">
                      <span class="sec-row__label">{{ row.unidade__nome }}</span>
                      <span class="sec-pill">{{ row.total }}</span>
                    </a>
                  {% elif row.unidade__id %}
                    <a class="sec-row" href="{% url 'org:unidade_detail' row.unidade__id %}">
                      <span class="sec-row__label">{{ row.unidade__nome }}</span>
                      <span class="sec-pill">{{ row.total }}</span>
                    </a>
                  {% else %}
                    <div class="sec-row" style="cursor:default;">
                      <span class="sec-row__label">{{ row.unidade__nome }}</span>
                      <span class="sec-pill">{{ row.total }}</span>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% else %}
              <div class="small" style="opacity:.85;">Sem dados para exibir.</div>
            {% endif %}
          </div>

          <!-- Minhas unidades (grid compacto clicável) -->
          <div class="sec-chart-box">
            <div class="sec-card-title">
              <h3>Minhas unidades</h3>
              <a class="link" href="{% url 'org:unidade_list' %}">Ver tudo</a>
            </div>

            <div class="sec-units-grid">
              {% for u in unidades %}
                <a class="sec-unit-tile" href="{% url 'org:unidade_detail' u.pk %}">
                  <div class="sec-unit-title">{{ u.nome }}</div>
                  {% if u.tipo %}
                    <div class="sec-unit-meta">{{ u.get_tipo_display }}</div>
                  {% endif %}
                </a>
              {% empty %}
                <div class="small" style="opacity:.85;">Nenhuma unidade cadastrada.</div>
              {% endfor %}
            </div>
          </div>

        </div>

        <!-- COLUNA DIREITA: Pizza + placeholder -->
        <div class="sec-stack">

          <div class="sec-chart-box">
            <div class="sec-card-title">
              <h3>Turmas por Unidade (Top 8)</h3>
              <span class="sec-pill">Analítico</span>
            </div>

            {% if graf_turmas_por_unidade %}
              <div class="sec-chart-wrap">
                <canvas id="chartTurmasPorUnidade" width="320" height="220"></canvas>
              </div>

              <script>
              (function () {
                const labels = [
                  {% for r in graf_turmas_por_unidade %}
                    "{{ r.unidade__nome|default:"Unidade"|escapejs }}"{% if not forloop.last %},{% endif %}
                  {% endfor %}
                ];
                const values = [
                  {% for r in graf_turmas_por_unidade %}
                    {{ r.total|default:0 }}{% if not forloop.last %},{% endif %}
                  {% endfor %}
                ];

                const colors = [
                  "#2B7CFF","#22C55E","#F59E0B","#A855F7",
                  "#EF4444","#06B6D4","#64748B","#F97316"
                ];

                function renderChart() {
                  if (!window.Chart) return;
                  const el = document.getElementById("chartTurmasPorUnidade");
                  if (!el) return;

                  new Chart(el, {
                    type: "doughnut",
                    data: {
                      labels: labels,
                      datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, values.length),
                        borderColor: "#ffffff",
                        borderWidth: 2
                      }]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        legend: { position: "bottom" }
                      },
                      cutout: "62%"
                    }
                  });
                }

                if (window.Chart) { renderChart(); return; }

                const s = document.createElement("script");
                s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
                s.onload = renderChart;
                document.head.appendChild(s);
              })();
              </script>
            {% else %}
              <div class="small" style="opacity:.85;">Sem dados para exibir.</div>
            {% endif %}
          </div>

          <!-- Placeholder pro próximo bloco (você coloca outro dado aqui depois) -->
          <div class="sec-placeholder">
            Espaço reservado para<br>novo indicador / gráfico
          </div>

        </div>

      </div>

    </div>
  </div>

</div>
{% endblock %}
