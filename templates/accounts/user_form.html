{% extends "core/base.html" %}

{% block title %}{% if mode == "create" %}Novo usuário{% else %}Editar usuário{% endif %} • GEPUB{% endblock %}
{% block header %}Usuários{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a class="breadcrumbs__link" href="{% url 'core:dashboard' %}">Início</a>
  <span class="breadcrumbs__sep">›</span>
  <a class="breadcrumbs__link" href="{% url 'accounts:usuarios_list' %}">Usuários</a>
  <span class="breadcrumbs__sep">›</span>
  <span>{% if mode == "create" %}Novo{% else %}Editar{% endif %}</span>
</div>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card__body">
    {% include "core/partials/components/layout/page_head.html" with title=title subtitle=subtitle actions=actions %}

    <form method="post" class="form-shell">
      {% csrf_token %}
      {% if form.non_field_errors %}<div class="alert alert--danger">{{ form.non_field_errors }}</div>{% endif %}
      <div class="form-shell__fields users-form-grid">
        <p>
          {{ form.first_name.label_tag }}
          {{ form.first_name }}
          {% if form.first_name.errors %}<span class="small u-text-danger">{{ form.first_name.errors|striptags }}</span>{% endif %}
        </p>
        <p>
          {{ form.last_name.label_tag }}
          {{ form.last_name }}
          {% if form.last_name.errors %}<span class="small u-text-danger">{{ form.last_name.errors|striptags }}</span>{% endif %}
        </p>
        <p class="users-form-grid__full">
          {{ form.email.label_tag }}
          {{ form.email }}
          {% if form.email.errors %}<span class="small u-text-danger">{{ form.email.errors|striptags }}</span>{% endif %}
        </p>

        <p>
          {{ form.cpf.label_tag }}
          {{ form.cpf }}
          {% if form.cpf.errors %}<span class="small u-text-danger">{{ form.cpf.errors|striptags }}</span>{% endif %}
          {% if mode == "create" %}<span class="small">Senha inicial = CPF (apenas números).</span>{% endif %}
        </p>
        <p>
          {{ form.role.label_tag }}
          {{ form.role }}
          {% if form.role.errors %}<span class="small u-text-danger">{{ form.role.errors|striptags }}</span>{% endif %}
        </p>

        <p>
          {{ form.municipio.label_tag }}
          {{ form.municipio }}
          {% if form.municipio.errors %}<span class="small u-text-danger">{{ form.municipio.errors|striptags }}</span>{% endif %}
        </p>
        <p>
          {{ form.secretaria.label_tag }}
          {{ form.secretaria }}
          {% if form.secretaria.errors %}<span class="small u-text-danger">{{ form.secretaria.errors|striptags }}</span>{% endif %}
        </p>
        <p>
          {{ form.unidade.label_tag }}
          {{ form.unidade }}
          {% if form.unidade.errors %}<span class="small u-text-danger">{{ form.unidade.errors|striptags }}</span>{% endif %}
        </p>
        <p>
          {{ form.setor.label_tag }}
          {{ form.setor }}
          {% if form.setor.errors %}<span class="small u-text-danger">{{ form.setor.errors|striptags }}</span>{% endif %}
        </p>

        <p id="turmas-wrap" class="users-form-grid__full users-form__turmas">
          {{ form.turmas.label_tag }}
          {{ form.turmas }}
          {% if form.turmas.errors %}<span class="small u-text-danger">{{ form.turmas.errors|striptags }}</span>{% endif %}
          <span class="users-form__note">Selecione uma ou mais turmas para usuário professor.</span>
        </p>

        <p class="users-form-grid__full users-form-grid__check">
          {{ form.ativo }} <span>{{ form.ativo.label }}</span>
        </p>
      </div>

      <div class="form-shell__actions">
        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-check"></i> Salvar</button>
        {% if mode == "update" and u %}
          <a class="btn btn--ghost" href="{% url 'accounts:usuario_detail' u.id %}">Detalhes</a>
        {% endif %}
        <a class="btn btn--ghost" href="{% url 'accounts:usuarios_list' %}">Cancelar</a>
      </div>
    </form>

    {% if mode == "update" and u %}
      <p class="small u-mt-12">
        <strong>Código de acesso:</strong> {{ u.profile.codigo_acesso }}
        {% if u.profile.must_change_password %}<span class="status warning">Troca de senha pendente</span>{% endif %}
      </p>
    {% endif %}
  </div>
</div>

<script>
(function () {
  const roleSelect = document.querySelector('[name="role"]');
  const turmasWrap = document.getElementById('turmas-wrap');
  if (!roleSelect || !turmasWrap) return;

  function syncVisibility() {
    const isProfessor = roleSelect.value === 'PROFESSOR';
    turmasWrap.style.display = isProfessor ? '' : 'none';
    if (!isProfessor) {
      const select = turmasWrap.querySelector('select');
      if (select) {
        for (const opt of select.options) opt.selected = false;
      }
    }
  }
  roleSelect.addEventListener('change', syncVisibility);
  syncVisibility();
})();
</script>
{% endblock %}
